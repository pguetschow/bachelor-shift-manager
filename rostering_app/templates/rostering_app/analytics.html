{% extends 'rostering_app/base.html' %}
{% load custom_filters %}

{% block title %}Analysen{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="bi bi-calendar-month"></i> {{ month_name }} {{ year }}
            </h1>
            <div class="btn-group">
                <a href="?year={{ prev_year }}&month={{ prev_month }}{% if selected_algorithm %}&algorithm={{ selected_algorithm }}{% endif %}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Drucken
                </button>
                <a href="?year={{ next_year }}&month={{ next_month }}{% if selected_algorithm %}&algorithm={{ selected_algorithm }}{% endif %}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h6 class="text-muted">Gesamtschichten</h6>
                <h2>{{ stats.total_shifts }}</h2>
                <small class="text-muted">im Monat</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card success">
            <div class="card-body">
                <h6 class="text-muted">Durchschn. Auslastung</h6>
                <h2>
                    {% if stats.coverage_by_shift %}
                        {% with total_percentage=0 count=0 %}
                        {% for shift_name, data in stats.coverage_by_shift.items %}
                            {% if forloop.first %}{{ data.percentage|floatformat:0 }}%{% endif %}
                        {% endfor %}
                        {% endwith %}
                    {% else %}
                        0%
                    {% endif %}
                </h2>
                <small class="text-muted">über alle Schichten</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card warning">
            <div class="card-body">
                <h6 class="text-muted">Mitarbeiter gesamt</h6>
                <h2>{{ stats.employee_distribution|length }}</h2>
                <small class="text-muted">aktiv im Zeitraum</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card danger">
            <div class="card-body">
                <h6 class="text-muted">Ø Stunden/Mitarbeiter</h6>
                <h2>
                    {% if stats.employee_distribution %}
                        {% for emp in stats.employee_distribution %}
                            {% if forloop.first %}{{ emp.hours|floatformat:0 }}{% endif %}
                        {% endfor %}
                    {% else %}
                        0
                    {% endif %}
                </h2>
                <small class="text-muted">Top-Performer</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Schichtabdeckung nach Typ</h5>
            </div>
            <div class="card-body">
                <canvas id="coverageChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Stundenverteilung Top 10</h5>
            </div>
            <div class="card-body">
                <canvas id="distributionChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Tables -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Schichtabdeckung Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Schicht</th>
                                <th>Ø Besetzung</th>
                                <th>Min/Max</th>
                                <th>Auslastung</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift_name, data in stats.coverage_by_shift.items %}
                            <tr>
                                <td>
                                    <span class="shift-badge shift-{{ shift_name|lower|cut:'shift' }} small">
                                        {{ shift_name|shift_display_name }}
                                    </span>
                                </td>
                                <td>{{ data.average|floatformat:1 }}</td>
                                <td>{{ data.min }}/{{ data.max }}</td>
                                <td>
                                    <div class="progress" style="height: 15px;">
                                        <div class="progress-bar {% if data.percentage < 80 %}bg-danger{% elif data.percentage < 95 %}bg-warning{% else %}bg-success{% endif %}"
                                             style="width: {{ data.percentage|floatformat:0 }}%">
                                            {{ data.percentage|floatformat:0 }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> Mitarbeiter-Ranking</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Schichten</th>
                                <th>Stunden</th>
                                <th>Auslastung</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for emp in stats.employee_distribution %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ emp.name }}</td>
                                <td>{{ emp.shifts }}</td>
                                <td>{{ emp.hours|floatformat:1 }}h</td>
                                <td>
                                    <div class="progress" style="height: 15px;">
                                        <div class="progress-bar" style="width: {{ emp.utilization|floatformat:0 }}%">
                                            {{ emp.utilization|floatformat:0 }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Coverage Chart Data
    const coverageLabels = [
        {% for shift_name, data in stats.coverage_by_shift.items %}
        '{{ shift_name|shift_display_name }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    const coverageData = [
        {% for shift_name, data in stats.coverage_by_shift.items %}
        {{ data.average|floatformat:1 }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Create Coverage Chart
    const coverageCtx = document.getElementById('coverageChart').getContext('2d');
    new Chart(coverageCtx, {
        type: 'bar',
        data: {
            labels: coverageLabels,
            datasets: [{
                label: 'Durchschnittliche Besetzung',
                data: coverageData,
                backgroundColor: ['#3498db', '#27ae60', '#e74c3c', '#f39c12'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Distribution Chart Data
    const distributionLabels = [
        {% for emp in stats.employee_distribution|slice:":5" %}
        '{{ emp.name }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    const distributionData = [
        {% for emp in stats.employee_distribution|slice:":5" %}
        {{ emp.hours|floatformat:1 }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Create Distribution Chart
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: distributionLabels,
            datasets: [{
                data: distributionData,
                backgroundColor: [
                    '#3498db',
                    '#27ae60',
                    '#f39c12',
                    '#e74c3c',
                    '#9b59b6'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 10,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.toFixed(1) + ' Stunden';
                            return label;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}